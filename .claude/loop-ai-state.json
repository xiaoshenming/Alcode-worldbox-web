{
  "notes": "迭代51完成。本轮核心工作：继续大规模扩展Creature系列系统测试覆盖。从1211个测试增长到1462个测试（+251个），测试文件从120个增到167个。新增47个测试文件覆盖E/F/G系列：E系列10个(Echolocation/Embosser/EmbroideryMakers/Enamalers/Enameller/Enchanting/Engravers/Engraver/Etcher/Exile)、F系列22个(Falconer/Fame/Farrier/Fashion/Felters/FeltingMakers/FeltingMakers2/Fermentation/FerruleMakers/Firewalker/Flanging/Flatter/Fletchers/Fletcher/Foraging/Forger/Founder/FringeMakers/Fuller/FullingMakers/Furbisher/Furriers)、G系列15个(Gambler/Gilders/Gilder/Girdler/Gladiator/Glassblowers/Glassblowing/Glazers/GlazierMaster/Glazier/Gondolier/Grinder/GrommetMakers/Grudge/Guild)。4个commit全部git push成功。TypeScript零错误，构建成功。修复的bug：1)FashionTrend接口无tick字段，2)FameSystem内部字段是fameRecords非fameMap，3)GlassWork缺少tradeValue字段，4)Glazer接口是artistry非reputation。",
  "priorities": [
    "1. 继续测试更多Creature系列系统（CreatureH/I/J/K/L系列）",
    "2. 探索非Creature系统中有getXxx方法的系统（如PopulationSystem/NavalSystem等）",
    "3. Game.ts仍有4045行（超标8倍）：loop(1038行)是最大候选，但依赖太多系统，风险高",
    "4. WorldEventSystem(813行)、WeatherDisasterSystem(741行) 超出质量门禁 500 行",
    "5. 目标：继续向1600+测试冲刺，当前1462个"
  ],
  "lessons": [
    "非空断言(!)是最常见的崩溃源 — 已在迭代26彻底清零",
    "子代理并行修复大批量文件非常高效：3组并行代理可在几分钟内修复100+文件",
    "manualChunks按文件名前���分组是最安全的代码分割方案 — 不改源码，只改vite配置",
    "Iterable<T>替代T[]可消除spread分配，但需检查消费端是否用了.length/.includes等数组方法",
    "getAllEntities()返回Array.from()快照 — removeEntity-during-iteration是安全的",
    "queue.shift()在BFS中是O(n²)陷阱 — 用索引指针head++替代",
    "Camera.getVisibleBounds()等热路径方法应返回缓存对象而非每次new — 每帧调用4次累积显著GC压力",
    "渲染路径中的闭包/对象字面量/getBoundingClientRect()都是隐性GC源 — 预分配+脏标记是标准修复模式",
    "数据驱动批量调度：703个系统调用按签名分类为6种类型(A-F)，用数组+for循环替代逐个调用，净减1147行",
    "预分配缓冲区模式：_xxxBuf数组只增长不收缩，_xxx.length=0重置视图，避免每次new对象",
    "IIFE闭包在tick路径中是隐性GC源 — 改为外部循环+持久化Set/变量",
    "find()/filter()/slice()链在嵌套循环中产生O(N²)闭包+数组 — 手动for循环+早退出是标准替代",
    "渲染管线不适合简单的数据驱动替换 — render调用间穿插条件逻辑和特殊参数，z-order顺序重要",
    "A*寻路用二叉堆替代线性数组是最高收益的算法优化 — pop从O(n)降到O(logn)，Map查重替代find()从O(n)降到O(1)",
    "SpatialHash字符串键(cx+','+cy)每次insert/query都产生GC — 改为数值编码cy*100000+cx零分配",
    "per-tick生物位置缓存模式：在系统update开头一次性收集所有生物位置到平坦数组，后续countSpeciesInArea直接遍历缓存而非反复getComponent",
    "4个独立系统的性能修复可以完美并行 — 4个opus子代理同时工作，总耗时等于最慢的一个",
    "接口注入模式：提取模块时定义只包含所需字段的接口(如GameInputContext)，Game通过`this as unknown as Interface`传入，避免循环依赖",
    "3个并行子代理可成功修改同一文件的不同区域 — 只要各自负责的方法边界清晰，提取可以并行完成",
    "vite循环chunk警告是rollup内部模块分配的结果，不影响构建成功和应用运行，可以作为提示接受",
    "puppeteer可用于无头浏览器测试：page.on('console')监听错误，page.screenshot()验证渲染",
    "page.metrics()可获取运行时性能数据：JSHeapUsedSize、ScriptDuration等",
    "项目健康度指标：JS Heap < 20MB、tsc零错误、构建成功、无运行时错误 = 优秀",
    "Vitest在vite.config.ts中添加test.environment='node'配置即可支持纯逻辑测试，无需额外配置文件",
    "测试依赖window/DOM的类时只测纯计算方法（如Camera的screenToWorld/worldToScreen/pan）跳过DOM相关方法",
    "全局计数器的测试用resetXxxCounter()在beforeEach重置，保证测试隔离",
    "mock World对象只需实现测试用到的接口方法（getTile+width+height），无需完整实现",
    "Camera.getVisibleBounds()依赖window.innerWidth/Height，在node环境不可测，跳过即可",
    "World构造函数调用generate()生成完整地图，测试用小尺寸(10x10)避免延迟 — new World(10,10)代替默认200x200",
    "EventLog是全局单例，测试前必须EventLog.clear()确保隔离 — 类似globalCivIdCounter的reset模式",
    "GeneticsSystem的mutate()有5%概率，需要循环10000次才能可靠触发一次 — 概率测试要设置足够大的循环次数",
    "getComponent<T>的泛型T必须extends Component(有type属性) — 用具体的Component子类型如CreatureComponent而非自定义对象字面量类型",
    "依赖复杂构造器(World/EntityManager/CivManager)的系统可用as any mock测试纯查询方法 — 只实现被测方法实际访问的字段",
    "SpatialHashSystem.query()返回的是可复用结果数组引用，测试时注意立即读取结果而非延迟（多次query会覆盖同一数组）",
    "TypeScript import路径要精确：测试文件在__tests__目录，导入systems/要用../systems/而非./systems/或./SystemName",
    "直接操作私有字段(as any).quests=[]可以注入测试数据，比复杂mock更简洁——适用于只测纯查询逻辑的场景",
    "CivManager.getRelationLabel/getCultureBonus/getReligionXxxBonus 是无副作用纯查询，只需向 civilizations Map 注入最小Civ对象即可测试",
    "向 territoryMap[y][x] 直接赋值可绕过 claimTerritory 的复杂逻辑，快速测试 getCivAt/isLandUnclaimed",
    "findNextStep 返回的是全局复用对象 _stepResult，如需保留结果需立即拷贝 {x: step.x, y: step.y}",
    "BloodMoonSystem的phase状态机（none/rising/peak/waning）可通过直接设置active+elapsed精确测试每个阶段的计算逻辑",
    "SeasonSystem的transitionProgress插值测试：设置transitionProgress<1可测试两季节之间的渐变计算（prev+delta*progress）",
    "WonderSystem的9个getXxxBonus方法都是简单的hasWonder条件返回，用as any注入activeWonders最快速",
    "AchievementProgressSystem.updateProgress完成后再次调用无效（if a.completed return），测试时注意覆盖此边界",
    "forEach箭头函数体中使用分号开头的语句（如;(as any)）需要加花括号：id => { ;(ws as any)... }，否则会被解析错误",
    "EraTransitionSystem的history容量上限测试：插入101条后getHistory()[0].tick应为1（第0条被shift移除）",
    "getEvents(count)内部用slice(-count)：count=0时-0===0，slice(0)返回全部，不是空数组 — 测试前先理解实现",
    "MiningSystem构造函数初始化WORLD_WIDTH*WORLD_HEIGHT的oreMap，200x200=40000格，在node测试环境仍然很快",
    "VolcanoSystem的最小间距检查：dx²+dy²<400（20格半径），测试时要用>20格确保创建成功",
    "TutorialSystem接受自定义steps参数，可绕过localStorage检查、完全控制步骤数量——是测试教程逻辑的最佳入口",
    "DiplomacySystem.getTreaties()过滤未破坏条约，返回新数组；getEvents()用slice返回副本——两者行为测试模式不同",
    "【重要安全规则】严禁用Write工具创建src/__tests__/目录内的文件！Write工具会将__转义为\\_\\_导致创建错误目录，必须用Bash cat heredoc方式创建测试文件",
    "rm -rf命令可能误删整个src目录（路径中含转义字符时）——立即git restore src/可恢复跟踪文件，但未跟踪的新文件会永久丢失",
    "Creature系列系统的测试模式极其统一：直接push到(sys as any).xxx数组/Map注入数据 + 验证getter返回内部引用或过滤结果",
    "大量Creature专业工匠系统（Annealer/Assayer/Beveller等）结构完全相同：单数组+getXxx()返回引用，测试5个最小覆盖已足够",
    "批量创建测试文件时用Bash cat heredoc并行执行效率最高 — 单轮可创建12-24个测试文件",
    "【关键经验】测试前必须先用grep确认接口字段！不同系统的同名方法字段可能完全不同（如Chaser.chasingSkill vs hammerControl，Cobbler类名是CreatureCobblersSystem）",
    "有些系统没有skillMap/getSkill方法（如Calderers/ClapMakers/Chandlers/CrochetMakers/Coopers/Curiers）——用tail/grep先确认再写测试",
    "CreatureCobblersSystem是文件名CreatureCobblerSystem.ts中导出的类（注意复数）— 类名vs文件名不一定一致",
    "CollectionSystem用Map而非数组存储，需用(sys as any).collections.set(id, data)注入而非.push()",
    "getDreamLog/getDivinations/getConstellations等返回内部引用（系统日志类型），getRecent/getRecentDreams用slice(-count)返回副本",
    "FameSystem内部私有字段是fameRecords（Map<EntityId, FameRecord>）非fameMap，必须用grep确认再注入",
    "接口字段reputation和artistry容易混淆——Glazer用artistry，而Felters/Furriers/Fletchers等用reputation",
    "GlassWork接口包含tradeValue字段——写factory function前必须grep -A10确认全部字段",
    "FashionTrend接口无tick字段——写factory时需用grep确认，有些系统的趋势/事件类型不含tick"
  ],
  "last_updated": "2026-02-27T16:48:00+08:00"
}
