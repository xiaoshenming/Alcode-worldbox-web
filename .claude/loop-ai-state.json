{
  "notes": "迭代31完成。核心工作：继续消除热路径GC分配。主要成果：1) FlockingSystem._groups从Map<string,EntityId[]>改为Map<number,Map<string,EntityId[]>>两层结构，消除每实体每15tick的模板字符串分配'${civId}:${species}'；2) FormationSystem.update(每帧)：f.members=f.members.filter()改为逆序splice，消除每帧每个formation的数组分配；3) TradeFleetSystem.update(每8tick)：ripples.filter()改为手动for计数；4) Renderer.ts：3个字体字符串(heroFont/artFont/stateFont)和resourceFont改为zoom缓存，zoom变化时才重建；5) LODRenderSystem.ts：两个字体字符串(fullFont/mediumFont)改为zoom缓存；6) CivManager.ts(每帧)：gatherResources中farms.filter()、updateHappiness中houses.filter()、updateReligion中temples.filter()三处都改为手动for计数，消除每帧每文明3次数组分配。测试：5434个全部通过，构建成功。",
  "priorities": [
    "1. Game.ts仍有4045行（超标8倍）：无filter/map，主要是系统调用密集；loop方法是最大拆分候选但风险高",
    "2. Renderer.ts(989行)仍超标：已完成主要GC优化；可考虑提取renderMinimap为独立方法文件",
    "3. WeatherDisasterSystem(747行)：render*私有方法仍耦合度高，拆分需要传递大量参数",
    "4. CivManager.autoBuild(0.2%概率)：Array.from(civ.territory)每次执行都创建数组，改为手动随机采样（用迭代器+计数）",
    "5. MigrationSystem.tryFormBands(每60tick)：speciesGroups每次都new Map()/new Map()创建临时数据结构，可改为预分配",
    "6. 继续扫描渲染系统中的字体字符串：BuildingVarietySystem、WorldMythicBeastSystem等渲染函数中还有字体字符串每帧创建"
  ],
  "lessons": [
    "非空断言(!)是最常见的崩溃点",
    "子代理并行修复大批量文件极高效：4组并行代理可在几分钟内修复160+文件",
    "manualChunks按文件名前缀分组是最安全的代码分割方案 — 不改源码，只改vite配置",
    "Iterable<T>替代T[]可消除spread分配，但需检查消费端是否用了.length/.includes等数组方法",
    "getAllEntities()返回Array.from()快照 — removeEntity-during-iteration是安全的",
    "queue.shift()在BFS中是O(n²)陷阱 — 用索引指针head++替代",
    "Camera.getVisibleBounds()等热路径方法应返回缓存对象而非每次new — 每帧调用4次累积显著GC压力",
    "渲染路径中的闭包/对象字面量/getBoundingClientRect()都是隐性GC源 — 预分配+脏标记是标准修复模式",
    "数据驱动批量调度：703个系统调用按签名分类为6种类型(A-F)，用数组+for循环替代逐个调用，净减1147行",
    "预分配缓冲区模式：_xxxBuf数组只增长不收缩，_xxx.length=0重置视图，避免每次new对象",
    "IIFE闭包在tick路径中是隐性GC源 — 改为外部循环+持久化Set/变量",
    "find()/filter()/slice()链在嵌套循环中产生O(N²)闭包+数组 — 手动for循环+早退出是标准替代",
    "渲染管线不适合简单的数据驱动替换 — render调用间穿插条件逻辑和特殊参数，z-order顺序重要",
    "A*寻路用二叉堆替代线性数组是最高收益的算法优化 — pop从O(n)降到O(logn)",
    "SpatialHash字符串键每次insert/query都产生GC — 改为数值编码零分配",
    "per-tick生物位置缓存模式：在系统update开头一次性收集所有生物位置到平坦数组",
    "接口注入模式：提取模块时定义只包含所需字段的接口，Game通过`this as unknown as Interface`传入，避免循环依赖",
    "vite循环chunk警告不影响构建成功和应用运行",
    "Vitest在vite.config.ts中添加test.environment='node'配置即可支持纯逻辑测试",
    "【重要安全规则】严禁用Write工具创建src/__tests__/目录内的文件！Write工具会将__转义为\\_\\_导致创建错误目录，必须用Bash cat heredoc方式创建测试文件",
    "Creature系列系统的测试模式极其统一：直接push到(sys as any).xxx数组/Map注入数据 + 验证getter返回内部引用或过滤结果",
    "批量创建测试文件时用Bash cat heredoc并行执行效率最高",
    "【关键经验】测试前必须先用grep确认接口字段！不同系统同名方法字段可能完全不同",
    "【重要】tsc --noEmit是必须步骤！每批创建后必须运行tsc验证，防止接口字段遗漏",
    "DOM构造函数系统（EnhancedTooltipSystem/PerformanceMonitorSystem）无法在Node环境实例化，只能有模块导入测试——是测试上限",
    "【迭代26新增】改Map<string,V>为Map<number,V>时：1)用cx*10000+cy编码（世界200x200安全）；2)必须同步更新测试中的注入代码；3)遍历时用Math.floor(key/10000)取cx，key%10000取cy",
    "【迭代26新增】从大文件拆分数据时，最安全模式是：提取常量/类型到*Definitions.ts，主文件只import并使用；不改变任何逻辑",
    "【迭代27新增】alive Set反模式：'const alive = new Set(em.getEntitiesWithComponent(creature))'在29+个系统存在，可用em.hasComponent(id,'creature')直接替代，零分配",
    "【迭代27新增】批量替换时Python脚本比sed更灵活——可以提取变量名后动态构造替换模式",
    "【迭代27新增】getDominantReligion等少量固定key的聚合操作，用Partial<Record<K,number>>比new Map()更轻量",
    "【迭代28新增】this.xxx = this.xxx.filter(...)在每帧调用的update()中是高优先级GC源 — 用for逆序+splice替代；如需同时更新元素，用普通for循环+splice",
    "【迭代28新增】new Set(arr.map(x => x.field))可用.some()替代来做存在性检查，零分配",
    "【迭代28新增】ctx.setLineDash([])每次调用都创建新数组 — 用static readonly _EMPTY_DASH=[]常量替代",
    "【迭代28新增】Edit工具替换时要特别注意目标字符串的唯一性，避免误删周围代码（尤其是函数签名）",
    "【迭代29新增】getEntitiesWithComponents()已返回EntityId[]，不需要[...spread]拷贝",
    "【迭代29新增】getter方法被热路径频繁调用时，可以用预分配_xxxBuf成员代替每次filter新数组，调用者必须意识到buf是共享可变的",
    "【迭代29新增】ctx.setLineDash([a*zoom,a*zoom])每帧新建数组 — 用_dashBuf[0]=val; _dashBuf[1]=val + setLineDash(_dashBuf)消除",
    "【迭代29新增】for(const [px,py] of [[x1,y1],[x2,y2]])每次创建2个临时数组 — 改为手动展开for(let mi=0;mi<2;mi++){const px=mi===0?x1:x2...}",
    "【迭代30新增】O(N²)热路径识别：内层循环中重复调用em.getEntitiesWithComponents()是O(N²)陷阱 — 在外层循环前一次性获取并传入",
    "【迭代30新增】语言/配置数据的filter分类结果可缓存到Map<id,{vowels,consonants}>，只在首次访问时计算",
    "【迭代30新增】对象数组{x,y,species}可改为平坦并行数组_xBuf/_yBuf/_speciesBuf，消除每元素对象分配",
    "【迭代30新增】Array.from(map.values())在每N tick执行的系统中可改为_buf.length=0; for(const v of map.values()) _buf.push(v)复用数组",
    "【迭代30新增】对象池模式：_memberPool: T[][]，_memberPoolNext=0在每次rebuild时重置，从池中取数组而非new Array(n)",
    "【迭代31新增】两层Map模式：Map<number,Map<string,T>>比Map<string,T>（key=`${num}:${str}`）更高效，外层数值键零分配，内层字符串键已存在无新分配",
    "【迭代31新增】渲染函数中的字体字符串缓存：_lastZoom + _xxxFont成员，zoom不变时直接复用，避免每帧模板字符串分配",
    "【迭代31新增】civ.buildings.filter(b => b.buildingType===X).length模式在每帧循环中是高GC源 — 改为手动for计数(0分配)"
  ],
  "last_updated": "2026-02-28T10:10:00+08:00"
}
