{
  "notes": "迭代84完成。深度GC优化第三十轮 — 共生成4个perf commit。主要成果：1) 删除9处死代码方法（无外部生产调用者），累计删减约250行：BattleReplaySystem.recordFrame（含new Array+push{}）、AmbientSoundMixer.getMixState+SoundMixState接口（含push({...ls})+map(e=>({...e}))）、ObjectPoolSystem.getAllStats（含3层嵌套return{}）、RuinsSystem.discoverRuin（含find+return{techBonus,cultureBonus}）、SeasonSystem.getTileColorShift（含两路return{r,g,b}）、EraVisualSystem.getUITheme（含return{borderColor,accentColor,bgAlpha}）、MinimapSystem.handleClick（含return{worldX,worldY}）、EventNotificationSystem.handleClick+getRecentEvents（含return{navigateTo:{x,y}}两层嵌套+数组push）；2) CreatureProfessionSystem.getBonus热路径优化：添加_bonusBuf预分配对象，将{...NEUTRAL_BONUS}spread分配改为原地reset+update，同时删除buildBonus函数和NEUTRAL_BONUS常量；3) 更新7个测试文件适配方法删除（私有字段直接读取替代）。5432测试全通过，TypeScript clean，构建成功，全部push完成。",
  "priorities": [
    "1. 扫描 LoyaltySystem.getCivCenter(return {x,y}) 和 pickEdgeTerritory — 每10帧叛乱检查，触发频率低，但可以优化",
    "2. 检查 GeneticsSystem.ts:53/88 return {} — 查找调用频率（crossbreed/mutate路径）",
    "3. 扫描 EntityInspectorSystem.buildTree — 事件驱动（点击实体时），但内部有大量push{}，可以优化",
    "4. 检查 GeneticDisplaySystem.ts:102/202 return {} — 是否有外部调用者",
    "5. 扫描 EraVisualSystem.getCurrentStyle — 私有方法，每帧render时调用，但返回EraVisualStyle对象（过渡期），可���缓存"
  ],
  "lessons": [
    "非空断言(!)是最常见的崩溃点",
    "子代理并行修复大批量文件极高效：4组并行代理可在几分钟内修复160+文件",
    "manualChunks按文件名前缀分组是最安全的代码分割方案 — 不改源码，只改vite配置",
    "Iterable<T>替代T[]可消除spread分配，但需检查消费端是否用了.length/.includes等数组方法",
    "getAllEntities()返回Array.from()快照 — removeEntity-during-iteration是安全的",
    "queue.shift()在BFS中是O(n²)陷阱 — 用索引指针head++替代",
    "Camera.getVisibleBounds()等热路径方法应返回缓存对象而非每次new — 每帧调用4次累积显著GC压力",
    "渲染路径中的闭包/对象字面量/getBoundingClientRect()都是隐性GC源 — 预分配+脏标记是标准修复模式",
    "数据驱动批量调度：703个系统调用按签名分类为6种类型(A-F)，用数组+for循环替代逐个调用，净减1147行",
    "预分配缓冲区模式：_xxxBuf数组只增长不收缩，_xxx.length=0重置视图，避免每次new对象",
    "IIFE闭包在tick路径中是隐性GC源 — 改为外部循环+持久化Set/变量",
    "find()/filter()/slice()链在嵌套循环中产生O(N²)闭包+数组 — 手动for循环+早退出是标准替代",
    "渲染管线不适合简单的数据驱动替换 — render调用间穿插条件逻辑和特殊参数，z-order顺序重要",
    "A*寻路用二叉堆替代线性数组是最高收益的算法优化 — pop从O(n)降到O(logn)",
    "SpatialHash字符串键每次insert/query都产生GC — 改为数值编码零分配",
    "per-tick生物位置缓存模式：在系统update开始一次性收集所有生物位置到平坦数组",
    "接口注入模式：提取模块时定义只包含所需字段的接口，Game通过`this as unknown as Interface`传入，避免循环依赖",
    "vite循环chunk警告不影响构建成功和应用运行",
    "Vitest在vite.config.ts中添加test.environment='node'配置即可支持纯逻辑测试",
    "【重要安全规则】严禁用Write工具创建src/__tests__/目录内的文件！Write工具会将__转义为\\_\\_导致创建错误目录，必须用Bash cat heredoc方式创建测试文件",
    "【迭代27新增】alive Set反模式：可用em.hasComponent(id,'creature')直接替代，零分配",
    "【迭代28新增】this.xxx = this.xxx.filter(...)在每帧调用的update()中是高优先级GC源 — 用for逆序+splice替代",
    "【迭代29新增】ctx.setLineDash([a*zoom,a*zoom])每帧新建数组 — 用_dashBuf[0]=val; _dashBuf[1]=val + setLineDash(_dashBuf)消除",
    "【迭代45新增】EventLog环形缓冲区模式：_buf[MAX]+_head+_count，shift()→_head=(head+1)%MAX",
    "【迭代47新增】预计算查找表模式（Record<EnumType,string>）：消除render路径中固定枚举的字符串操作",
    "【迭代47新增】Map复用模式：不new Map()而是复用_xxxCache，reset各entry字段",
    "【迭代48新增】整数查找表模式：0-10范围的整数用预计算的_INT_STR=['0','1',...,'10']查找表，避免String(n)分配",
    "【迭代49新增】对象数组→平坦缓冲区模式：unclaimed:{id,x,y}[]改为_idBuf/_xBuf/_yBuf三个数组",
    "【迭代53新增】方法内字面量数组反模式：const types: FooType[] = ['a','b','c'] 在每次调用时重建 — 提取为模块级常量",
    "【迭代56新增】EcosystemSystem热路径：Array.includes→Set.has是最高收益优化",
    "【迭代63新增】render路径字符串缓存模式：对于低频变化的显示值，在值变化时重建缓存字符串，render直接用缓存",
    "【迭代65新增】系统级header字符串缓存模式：在数据变化时重建，render直接用",
    "【迭代67新增】外部设置数据时批量预计算字符串：updateXxx等在接收外部数据时一次性预计算所有render需要的字符串缓存",
    "【迭代69新增】float64Array平坦缓冲区替代number[][]嵌套数组：cumulative[i][c]改为_cumBuf[i*STRIDE+c]",
    "【迭代72新增】字符串脏标记改数值比较模式：_prevA, _prevB + if(a!==_prevA||b!==_prevB)——消除每帧临时字符串",
    "【迭代72新增】BattleReplaySystem.findMVP是O(frames×units²)复杂度，每render调用极贵——移至stopRecording时一次性计算并存mvpStr",
    "【迭代73新增】??fallback永不触发的识别模式：接口已保证字段赋值（addXxx内设置）时，render路径??fallback是冗余GC源，用!替代",
    "【迭代73新增】颜色字符串拼接预计算：color+'33'/color+'44'/color+'CC'等固定后缀在模块初始化时预计算为查找表",
    "【迭代73新增】脏标记缓存render路径中的O(N)计算：getOrderedSamples()/buildLayout()等在数据变化时设置_xxxDirty=true，render时检查后按需重建",
    "【迭代73新增】测量宽度缓存模式：ctx.measureText(fixedLabel)的结果在label不变时可安全缓存（font不变时），类型切换才重测",
    "【迭代73新增】updatePowerData/setTechData原地复用数组和对象：.map()+spread展开改为length赋值+for循环原地更新，消除每次调用的数组+对象分配",
    "【迭代74新增】createRadialGradient替代模式：对于小粒子/光晕效果，用双层实心圆+globalAlpha替代，视觉效果相近但完全无GC分配",
    "【迭代74新增】measureText缓存带失效条件：textWidth=0初始化，失效条件（zoom变化/label变化/type切换）时重置为0，render首次调用时测量",
    "【迭代74新增】truncateText结果缓存模式：将截断结果存到数据对象上（descTruncated+descTruncatedMaxW），maxW不变时直接使用缓存，避免O(N)字符级measureText循环",
    "【迭代74新增】WorldHeatmap图例渐变替代：用预计算的HEATMAP_COLOR_TABLE 100段小矩形拼接替代createLinearGradient，完全固定颜色时的最优方案",
    "【迭代75新增】粒子池化通用模式：固定MAX_SIZE数组+maxLife=0为空槽，spawn时找空槽复用，update时maxLife=0跳过，render时检查，消除splice和push对象字面量",
    "【迭代75新增】per-entity save/restore消除：多粒子/泡泡循环中，用globalAlpha直接设置+循环后restore替代per-item save/restore，可减少N次状态栈分配",
    "【迭代75新增】wrapText结果缓存+computeWrappedLines分离：将渲染函数拆为compute（返回lines[]）和draw（迭代lines），缓存到数据对象上按内容变化失效",
    "【迭代75新增】flatten脏标记缓存：树结构变化时设_flatDirty=true（toggle/inspect/close），render时只在dirty时重建_flatBuf，正常帧零分配",
    "【迭代75新增】白盒测试与池化的兼容性：改数组为预分配池后，依赖array.length的测试会失败——需同步更新getXxxCount()方法只计活跃槽（maxLife>0等条件）",
    "【迭代76新增】对称缓存模式：已有_minT/minTStr缓存时，检查是否也需要_maxT缓存——render路径中成对出现的O(N)scan应同时消除",
    "【迭代76新增】findXxx从线性数组改为Map索引：render/update热路径中每次调用findXxx(id)的O(N)搜索，改为维护idToItem: Map<id, Item>实现O(1)查找",
    "【迭代76新增】预分配对象数组+虚拟长度计数器：_xxxBuf数组预分配N个固定对象+_xxxCount=0，写时slot.field=value，读时for(let i=0;i<count;i++)迭代，比push{}零分配",
    "【迭代79新增】getter方法返回{...}的识别模式：getPanelRect/panelRect()等每帧调用的方法，若返回{x,y,w,h}，应改为缓存对象+screenW/H脏标记，仅屏幕尺寸变化时重算",
    "【迭代79新增】EntityManager.getEntitiesWithComponents优化：rest参数(...types)每次都产生新数组+join产生新字符串；2/3参数可用+拼接，内部maps数组可用_mapsBuf复用",
    "【迭代79新增】??fallback的有效性验证方法：检查接口定义（?:可选字段）和赋值位置（addXxx/initXxx是否总执行），如总赋值则??永不触发，可安全改为!",
    "【迭代80新增】getMoodModifier固定返回三种对象：预计算为模块级const单例(_MOD_HIGH/LOW/NEUTRAL)，函数直接return常量引用，零GC",
    "【迭代80新增】createRadialGradient/createLinearGradient with dynamic alpha：alpha每帧变化时无法缓存CanvasGradient对象，改用4矩形+globalAlpha的vignette方案（可接受视觉差异）",
    "【迭代80新增】EventLog._buf预分配+原地复用：预分配MAX_EVENTS个WorldEvent对象，log()时直接更新slot字段，消除每次new WorldEvent{}",
    "【迭代80新增】queryCache条目复用：hit path直接更新entry.version+entry.result，miss path且key已存在也直接更新而非set新{}，仅key首次出现时才new",
    "【迭代80新增】多个连续save/restore可以合并：两个独立的ctx.save/restore块若设置的是可直接覆盖的属性（globalAlpha/strokeStyle/fillStyle），可合并为1个save/restore，中间直接改属性",
    "【迭代81新增】枚举switch固定返回N个对象：提取为N个模块级const单例，switch直接return引用 — 7种OreType→7个_BONUS_XXX常量，零GC分配",
    "【迭代81新增】死代码识别：grep整个src目录（排除tests）确认方法名无调用者后直接删除，消除潜在分配",
    "【迭代81新增】{...spread,extra}展开+追加模式：改为_cacheObj原地更新所有字段（.rendered/.culled/.lod），避免每次getStats()展开新对象",
    "【迭代81新增】热路径穷举扫描策略：grep return {} + grep push({} + grep new Map/Set/Array，逐条验证调用路径频率，区分热路径（每帧/每tick）vs冷路径（事件驱动）",
    "【迭代83新增】粒子数组splice+push方案→swap-remove模式：逆序swap-remove比splice快O(1)，将最后一个活跃槽字段复制到被删除槽，_particleCount--即可，零GC",
    "【迭代83新增】new XXX()但未赋值的死实例化：grep 'new XxxSystem()' 无赋值目标时为纯死代码，连同import一并删除",
    "【迭代83新增】测试文件中 getSummary()/getXxx() 类型的便利方法删除后，改为 (st as any).privateField 直接读取私有字段，确保不重复触发GC分配",
    "【迭代83新增】扫描模式：grep 'return {' + 确认调用者 + 判断频率 — 死代码方法无调用者直接删，低频(<60tick)可暂留，高频(每帧)必须缓存",
    "【迭代84新增】删除死代码前必须确认：grep -rn 'methodName' src/game/ src/systems/ — 不只grep src/，因为Game.ts中可能有内部调用（如CreatureProfessionSystem.getBonus在render中调用）",
    "【迭代84新增】热路径Record<K,V>预分配缓存模式：getBonus这类返回固定结构Record对象的方法，添加_bonusBuf预分配，改为原地reset+更新字段返回，零GC",
    "【迭代84新增】死代码扫描批量策略：同时检查handleClick/getRecentEvents/getMixState/getAllStats等UI类方法，这类方法常因UI重构而失去调用者"
  ],
  "last_updated": "2026-03-01T12:55:00+08:00"
}
