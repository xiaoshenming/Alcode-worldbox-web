{
  "notes": "迭代21完成。核心工作：为83个非World*/非Diplomatic*系统添加141个单元测试，从4276个测试增长到4417个测试（+141个），测试文件从847增到930个（+83个文件）。重要里程碑：所有系统（World*/Diplomatic*/其他）均已有测试覆盖！测试覆盖率达到100%系统级别。关键发现：1) PerformanceMonitorSystem在构造函数中调用window.addEventListener，需要DOM环境，只能做模块导入测试；2) EnhancedTooltipSystem使用document.createElement，同样只能做模块导入测试；3) TameState.Tamed=2（Wild=0,Taming=1,Tamed=2），不是1；4) CreaturePersonalitySystem.getDecisionBias未知实体返回0，不是0.5；5) EmotionEntry字段是emotion，不是type。TypeScript零错误，所有测试通过，commit已推送。",
  "priorities": [
    "1. 【里程碑达成】所有系统均已有测试覆盖！当前4417个测试，930个测试文件。下一步：提升测试质量，为复杂系统添加更深入的测试",
    "2. Game.ts仍有4045行（超标8倍）：loop(1038行)是最大候选，但依赖太多系统，风险高",
    "3. WorldEventSystem(813行)、WeatherDisasterSystem(741行) 超出质量门禁 500 行，考虑拆分",
    "4. 部分系统只有模块导入测试（AISystem/CombatSystem/DisasterSystem/WeatherSystem/EnhancedTooltipSystem/PerformanceMonitorSystem），可以考虑用mock依赖来添加更实质性的测试",
    "5. 考虑为ECS核心（Entity/Component/System基类）添加更全面的测试"
  ],
  "lessons": [
    "非空断言(!)是最常见的崩溃源 — 已在迭代26彻底清零",
    "子代理并行修复大批量文件极常高效：3组并行代理可在几分钟内修复100+文件",
    "manualChunks按文件名前缀分组是最安全的代码分割方案 — 不改源码，只改vite配置",
    "Iterable<T>替代T[]可消除spread分配，但需检查消费端是否用了.length/.includes等数组方法",
    "getAllEntities()返回Array.from()快照 — removeEntity-during-iteration是安全的",
    "queue.shift()在BFS中是O(n²)陷阱 — 用索引指针head++替代",
    "Camera.getVisibleBounds()等热路径方法应返回缓存对象而非每次new — 每帧调用4次累积显著GC压力",
    "渲染路径中的闭包/对象字面量/getBoundingClientRect()都是隐性GC源 — 预分配+脏标记是标准修复模式",
    "数据驱动批量调度：703个系统调用按签名分类为6种类型(A-F)，用数组+for循环替代逐个调用，净减1147行",
    "预分配缓冲区模式：_xxxBuf数组只增长不收缩，_xxx.length=0重置视图，避免每次new对象",
    "IIFE闭包在tick路径中是隐性GC源 — 改为外部循环+持久化Set/变量",
    "find()/filter()/slice()链在嵌套循环中产生O(N²)闭包+数组 — 手动for循环+早退出是标准替代",
    "渲染管线不适合简单的数据驱动替换 — render调用间穿插条件逻辑和特殊参数，z-order顺序重要",
    "A*寻路用二叉堆替代线性数组是最高收益的算法优化 — pop从O(n)降到O(logn)，Map查重替代find()从O(n)降到O(1)",
    "SpatialHash字符串键(cx+','+cy)每次insert/query都产生GC — 改为数值编码cy*100000+cx零分配",
    "per-tick生物位置缓存模式：在系统update开头一次性收集所有生物位置到平坦数组，后续countSpeciesInArea直接遍历缓存而非反复getComponent",
    "4个独立系统的性能修复可以完美并行 — 4个opus子代理同时工作，总耗时等于最慢的一个",
    "接口注入模式：提取模块时定义只包含所需字段的接口(如GameInputContext)，Game通过`this as unknown as Interface`传入，避免循环依赖",
    "3个并行子代理可成功修改同一文件的不同区域 — 只要各自负责的方法边界清晰，提取可以并行完成",
    "vite循环chunk警告是rollup内部模块分配的结果，不影响构建成功和应用运行，可以作为提示接受",
    "Vitest在vite.config.ts中添加test.environment='node'配置即可支持纯逻辑测试，无需额外配置文件",
    "【重要安全规则】严禁用Write工具创建src/__tests__/目录内的文件！Write工具会将__转义为\\_\\_导致创建错误目录，必须用Bash cat heredoc方式创建测试文件",
    "Creature系列系统的测试模式极其统一：直接push到(sys as any).xxx数组/Map注入数据 + 验证getter返回内部引用或过滤结果",
    "批量创建测试文件时用Bash cat heredoc并行执行效率最高 — 单轮可创建12-24个测试文件",
    "【关键经验】测试前必须先用grep确认接口字段！不同系统同名方法字段可能完全不同",
    "有些系统没有skillMap/getSkill方法——用grep先确认再写测试",
    "【重要】tsc --noEmit是必须步骤！每批创建后必须运行tsc验证，防止接口字段遗漏",
    "ResourceScarcitySystem的ResourceStock字段是capacity/consumptionRate/productionRate，不是max/production/consumption",
    "for循环中的(sys as any).xxx.push()前面不能有分号——分号会让push成为独立语句而非循环体",
    "WorldCorruptionSystem用Float32Array存储腐败度，直接array[index] = value注入数据",
    "WorldFertilitySystem需要先调用init(w, h, tiles)才能使用getFertility/getAverageFertility",
    "WorldAgeSystem初始（tick=0）epoch是PRIMORDIAL，displayName='太初'，getDisasterFrequencyModifier()返回2.0>1",
    "WorldNarratorSystem的addNarrative是公共API，无需手动注入entries数组，通过addNarrative写入数据更自然",
    "WorldCoralReefSystem.getReefAt用近似匹配（±2格）而非精确匹配——测试时相邻坐标也应返回结果",
    "WorldUndergroundSystem有getCaves()/getDiscoveredCaves()/getTotalDiscovered()三个getter，比单一getter更丰富",
    "WorldMemorialSystem.getByType(type)按类型过滤——比直接返回所有的系统多一层过滤逻辑",
    "WorldWeatherFrontSystem有getFronts()/getCollisions()/getFrontAt()三个getter——FrontCollision是frontA/frontB碰撞对",
    "每轮可以批量创建60+个测试文件，单轮净增300个测试是可行的",
    "网络断连时先commit本地，待网络恢复后批量push——git会自动合并推送",
    "WorldDecorationSystem用grid二维数组+decorationCount计数器，不是decorations数组——count getter直接返回decorationCount",
    "有些系统用isVisible()方法而非getter——WorldDashboardSystem/WorldStatsOverviewSystem都是方法调用",
    "WorldEventSystem.getActiveEvents()返回映射后的新数组（非内部引用），测试时不能用toBe检查引用",
    "WorldMigrationWaveSystem内部数组名是activeWaves，不是waves——命名与getter名一致",
    "Diplomatic*系统模式极其统一：私有数组+getter，用for循环批量生成测试文件效率最高——单轮187个文件+375个测试",
    "DiplomaticSheriffaltySytem文件名拼写错误（缺少S），类名是DiplomaticSheriffaltySystem——测试时import类名需用正确拼写",
    "DiplomaticSummitSystem有getActiveSummit()返回单个对象（非数组），初始为null——测试用toBeNull()而非toHaveLength(0)",
    "批量生成arrangements系统测试时用shell for循环+heredoc最高效——80个同类系统可在一条命令内全部生成",
    "DOM依赖系统（EnhancedTooltipSystem/PerformanceMonitorSystem）在node环境只能做模块导入测试——不要尝试实例化",
    "TameState是const enum：Wild=0, Taming=1, Tamed=2——注入测试数据时state必须用正确数值",
    "CreaturePersonalitySystem.getDecisionBias未知实体返回0（不是0.5）——测试前必须grep确认返回值",
    "EmotionEntry字段是emotion（不是type）——不同系统的情绪字段命名不同，必须grep确认"
  ],
  "last_updated": "2026-02-27T20:38:00+08:00"
}
